%&context
%%
%% Kanji and Hanzi writing practice sheets
%% Environment definition


\startenvironment env_sheet

\setuplayout[top=1cm,header=0pt,bottom=1cm,footer=20pt]

\usemodule[simplefonts]

%% enter font to be used here
\setmainfont[stkaiti]

\setupbodyfont[base, 12pt]
\setuppagenumber[state=start]
%\setupindenting[none]
\setuppagenumbering[location=footer]


%% Change for different size:
\def\kanjisize{15mm}
\def\pinyinsize{4mm}
\definefont[bigfont][Regular at \kanjisize]
\definefont[smallfont][Regular at \pinyinsize]
\definefont[smallfontbold][RegularBold at \pinyinsize]

\startuseMPgraphic{line}
  pickup pencircle scaled .7pt;
  picture c, box;
  c=\sometxt{\MPvar{c}};
  color grey;
  grey=0.8*white;
  draw unitsquare scaled \kanjisize\space withcolor 0.25white;
  pickup pencircle scaled 0.5pt;
  draw .5[llcorner currentpicture,lrcorner currentpicture] --
    .5[ulcorner currentpicture,urcorner currentpicture]
    withcolor grey;
  draw .5[llcorner currentpicture,ulcorner currentpicture] --
    .5[lrcorner currentpicture,urcorner currentpicture]
    withcolor grey;
  draw llcorner currentpicture --
    urcorner currentpicture
    withcolor grey;
  draw ulcorner currentpicture --
    lrcorner currentpicture
    withcolor grey;
  box := currentpicture;
  setbounds box to boundingbox box enlarged -1pt;
  currentpicture := nullpicture;

  numeric imax;
  imax = 180mm/bbwidth(box);
  draw box shifted (1*bbwidth(box), 0pt);
  draw c shifted ((center box)-(center c) + (1*bbwidth(box), 0pt))
    withcolor 0.1*white;
  for i = 2 step 1 until imax:
    %if i = 1:
    %  draw c shifted ((center box)-(center c) + (i*bbwidth(box), 0pt))
    %    withcolor (0.5+i/(imax+15))*white;
    %fi;
    draw box shifted (i*bbwidth(box), 0pt);
  endfor;
\stopuseMPgraphic

\def\line#1{{%
  \par
  \leavevmode
  \bigfont
  \useMPgraphic{line}{c=#1}%
  \vskip 5mm
  \par
}}

\setuplines
  [before={\startframedtext[frame=off]},
   after=\stopframedtext]

\def\linedesc#1#2#3{{%
  \startlines
  \par
  \smallfont
  #1 -- {\smallfontbold #2} -- #3
  \par
  \leavevmode
  \bigfont
  \useMPgraphic{line}{c=#1}%
  \stoplines
  \vskip -15mm
}}


\startluacode
	userdata = userdata or {}

	--reads a file with one hanzi per line
	--generates TeX code for including each hanzi
	function userdata.readhanzi(file)
		for l in io.lines(file) do
			tex.sprint("\\line{" .. l .. "}\n")
		end
	end
\stopluacode


\usemodule[filter]

\defineexternalfilter
  [anki]
  [filtercommand={./filter.py --tex --pinyin \externalfilterinputfile \space
                                             \externalfilteroutputfile}]


\stopenvironment
